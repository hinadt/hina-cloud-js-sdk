!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).hinaDataStatistic={})}(this,(function(t){"use strict";var e=function(t,o){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])},e(t,o)};function o(t,o){if("function"!=typeof o&&null!==o)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");function r(){this.constructor=t}e(t,o),t.prototype=null===o?Object.create(o):(r.prototype=o.prototype,new r)}var r,n,i,a=function(){return a=Object.assign||function(t){for(var e,o=1,r=arguments.length;o<r;o++)for(var n in e=arguments[o])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t},a.apply(this,arguments)};function s(t,e,o,r){return new(o||(o=Promise))((function(n,i){function a(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(a,s)}c((r=r.apply(t,e||[])).next())}))}function c(t,e){var o,r,n,i={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=s(0),a.throw=s(1),a.return=s(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(c){return function(s){if(o)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(i=0)),i;)try{if(o=1,r&&(n=2&s[0]?r.return:s[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,s[1])).done)return n;switch(r=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(n=i.trys,(n=n.length>0&&n[n.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){i.label=s[1];break}if(6===s[0]&&i.label<n[1]){i.label=n[1],n=s;break}if(n&&i.label<n[2]){i.label=n[2],i.ops.push(s);break}n[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],r=0}finally{o=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}}function u(t){var e="function"==typeof Symbol&&Symbol.iterator,o=e&&t[e],r=0;if(o)return o.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function l(t,e){var o="function"==typeof Symbol&&t[Symbol.iterator];if(!o)return t;var r,n,i=o.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(t){n={error:t}}finally{try{r&&!r.done&&(o=i.return)&&o.call(i)}finally{if(n)throw n.error}}return a}function p(t,e,o){if(o||2===arguments.length)for(var r,n=0,i=e.length;n<i;n++)!r&&n in e||(r||(r=Array.prototype.slice.call(e,0,n)),r[n]=e[n]);return t.concat(r||Array.prototype.slice.call(e))}"function"==typeof SuppressedError&&SuppressedError,t.ConsoleTypes=void 0,(r=t.ConsoleTypes||(t.ConsoleTypes={})).LOG="log",r.INFO="info",r.WARN="warn",r.ERROR="error",r.ASSERT="assert",t.ReportTypes=void 0,(n=t.ReportTypes||(t.ReportTypes={})).BEACON="beacon",n.IMAGE="image",n.AJAX="ajax",t.VariablesTypes=void 0,(i=t.VariablesTypes||(t.VariablesTypes={})).INTEGER="INTEGER",i.STRING="STRING",i.BOOLEAN="BOOLEAN";var h=function(t,e){this.options=t,this.context=e,this.disabled=!1},f=["utm_source","utm_medium","utm_campaign","utm_content","utm_term"];p(p([],l(f),!1),l(["ha_utm"]),!1);var d=["www.baidu.","m.baidu.","m.sm.cn","so.com","sogou.com","youdao.com","google.","yahoo.com/","bing.com/","ask.com/"],g=["weibo.com","renren.com","kaixin001.com","douban.com","qzone.qq.com","zhihu.com","tieba.baidu.com","weixin.qq.com"],v={baidu:["wd","word","kw","keyword"],google:"q",bing:"q",yahoo:"p",sogou:["query","keyword"],so:"q",sm:"q"},m="hinasdk_domain_test",y=Object.prototype.toString;function b(t){return"[object Object]"===y.call(t)}function w(t){return null!=t}function _(t){return Array.isArray(t)}function T(t){return"function"==typeof t}function S(t){return"string"==typeof t}function x(t){return"number"==typeof t&&!Number.isNaN(t)}function k(t){return"boolean"==typeof t}function C(){}function H(t){try{return JSON.parse(t)}catch(t){}return t}function A(t){return 0===Object.keys(t).length}function R(){return Date.now&&T(Date.now)?Date.now():(new Date).getTime()}function I(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var o=Object.create(null);return t.forEach((function(t){t&&Object.keys(t).forEach((function(e){var r=t[e];b(r)?b(o[e])?o[e]=I(o[e],r):o[e]=I(r):o[e]=r}))})),o}function P(t){var e={};try{e=new URL(t)}catch(t){}return e}function N(t,e){if(!t)return t;var o=t.toString(),r=o.indexOf(".");return o=-1!==r?o.substring(0,r+e+1):o.substring(0),parseFloat(o)}function L(t){t=t||window.location.hostname,/^[a-zA-Z0-9\u4e00-\u9fa5\-\\.]+$/.exec(t)||(t="");var e=t.split(".");if(e.length>=2&&!/^(\d+\.)+\d+$/.test(t))for(var o=".".concat(e.splice(e.length-1,1));e.length>0;)if(o=".".concat(e.splice(e.length-1,1)).concat(o),document.cookie="".concat(m,"=true; path=/; domain=").concat(o),-1!==document.cookie.indexOf("".concat(m,"=true")))return document.cookie="".concat(m,"=true; path=/; domain=").concat(o,"; max-age=0"),o;return""}function E(){var t=L();return""===t?"url解析失败":t}function O(t){var e=t||document.referrer;return"string"!=typeof e?"referrer exception".concat(String(e)):(e.startsWith("https://www.baidu.com/")&&(e=e.split("?")[0]),"string"==typeof(e=e.slice(0,200))?e:"")}function D(t,e){return e&&"string"==typeof e||(e="hostname解析异常"),t&&(P(t).hostname||"")||e}function U(){var t=R(),e=Math.floor(1e6*Math.random());return Number(String(t).slice(-5)+String(e).slice(0,4))}function B(t,e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),t=decodeURIComponent(t);var o=new RegExp("[\\?&]".concat(e,"=([^&#]*)")).exec(t);return null===o||o&&"string"!=typeof o[1]&&o[1].length?"":decodeURIComponent(o[1])}function W(t){try{return btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,(function(t,e){return String.fromCharCode(Number("0x".concat(e)))})))}catch(e){return t}}function M(t,e,o,r){if(void 0!==t&&(e in t||r)){var n=o(t[e]);T(n)&&(t[e]=n)}}var j=function(){function t(){this.name="CookieStorage"}return t.prototype.isSupport=function(t,e){var o=this;void 0===t&&(t="cookie_support_test"),void 0===e&&(e="1");return navigator.cookieEnabled&&(o.set(t,e),o.get(t)===e&&(o.remove(t),!0))},t.prototype.get=function(t){var e,o,r=document.cookie.split(";");try{for(var n=u(r),i=n.next();!i.done;i=n.next()){var a=i.value.split("=");if(a[0].trim()===t)return decodeURIComponent(a[1])}}catch(t){e={error:t}}finally{try{i&&!i.done&&(o=n.return)&&o.call(n)}finally{if(e)throw e.error}}return null},t.prototype.set=function(t,e,o,r,n,i,a){r=r||"/",t=t.trim(),e=e.trim();var s="".concat(t,"=").concat(encodeURIComponent(e),"; path=").concat(r,";");o=w(o)?o:63072e8,s+=" max-age=".concat(o,";"),a&&(s+=" secure;"),n&&(s+=" domain=".concat(n,";")),["Strict","Lax","None"].includes(i)&&(s+=" SameSite=".concat(i,";")),document.cookie=s},t.prototype.remove=function(t,e){void 0===e&&(e="/"),this.set(t,"1",0,e)},t.prototype.setDomain=function(t,e,o){var r=E();"url解析失败"===r&&(r=""),this.set(t,e,o,"/",r)},t}(),q=function(){function t(){this.name="LocalStorage"}return t.prototype.isSupport=function(){var t=!0;try{var e="__localStorageSupport__",o="testIsSupportStorage";this.set(e,o),this.get(e)!==o&&(t=!1),this.remove(e)}catch(e){t=!1}return t},t.prototype.key=function(t){return window.localStorage.key(t)},t.prototype.get=function(t){return window.localStorage.getItem(t)},t.prototype.length=function(){return window.localStorage.length},t.prototype.set=function(t,e){try{window.localStorage.setItem(t,e)}catch(t){}},t.prototype.remove=function(t){window.localStorage.removeItem(t)},t.prototype.parse=function(t){var e=this.get(t);try{e=JSON.parse(e)}catch(t){e=""}return e},t}(),F=function(){function t(){this.name="MemoryStorage",this.data={}}return t.prototype.get=function(t){var e=this.data[t];return w(null==e?void 0:e.expireTime)?e.expireTime<R()?null:e.value:null==e?void 0:e.value},t.prototype.set=function(t,e,o){if(w(o)){var r=R()+1e3*o;this.data[t]={value:e,expireTime:r}}this.data[t]={value:e}},t.prototype.setDomain=function(t,e,o){this.set(t,e,o)},t}();function V(e,o){if(void 0===o&&(o=t.ConsoleTypes.LOG),"undefined"!=typeof console){var r=console[o]||console.log;"function"==typeof r&&r(e)}}var z,K={all:z=z||new Map,on:function(t,e){var o=z.get(t);o?o.push(e):z.set(t,[e])},emit:function(t,e){var o=z.get(t);o&&o.forEach((function(t){t(e)}))},off:function(t,e){var o=z.get(t);if(o)if(e){var r=o.indexOf(e);r>=0&&o.splice(r,1)}else z.set(t,[])}},J=function(){function e(t,e){this.options=t,this.isFirstTime=!1,this.isFirstDay=!1,this.state=e}return e.prototype.log=function(e,o){void 0===o&&(o=t.ConsoleTypes.LOG),this.options.showLog&&V(e,o)},e.prototype.checkSetValue=function(e,o){return!(!x(o=null!=o?o:"")&&!S(o))||(this.log("".concat(e,": id must be string or number"),t.ConsoleTypes.WARN),!1)},e.prototype.setDeviceId=function(t){void 0===t&&(t=""),this.checkSetValue("deviceId",t)&&this.set("deviceId",t)},e.prototype.setAccountId=function(t){void 0===t&&(t=""),this.checkSetValue("accountId",t)&&(this.set("accountId",t),K.emit("changeAccountId"))},e.prototype.setAnonymousId=function(e){this.state.anonymousId?this.log("Current anonymousId is ".concat(this.getAnonymousId(),", it has been set"),t.ConsoleTypes.WARN):this.checkSetValue("anonymousId",e)&&this.set("anonymousId",e)},e.prototype.setProps=function(t){var e=I(this.state.props||{},t);for(var o in e)"string"==typeof e[o]&&(e[o]=e[o].slice(0,200));this.set("props",e)},e.prototype.getAnonymousId=function(){return this.state.anonymousId},e.prototype.getDeviceId=function(){return this.state.deviceId},e.prototype.getAccountId=function(){return this.state.accountId},e.prototype.clear=function(){this.state={},this.save()},e.prototype.set=function(t,e){this.state[t]=e,this.save()},e.prototype.afterInit=function(t){t?(this.isFirstDay=function(t){var e;try{var o=new Date,r=o.getFullYear(),n=o.getMonth()+1,i=o.getDate(),a=new Date(t),s=a.getFullYear(),c=a.getMonth()+1,u=a.getDate();e=r===s&&n===c&&i===u}catch(t){e=!1}return e}(this.state.firstVisitTime),this.save()):(this.isFirstDay=!0,this.isFirstTime=!0);var e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return"x"===t?e.toString(16):(3&e|8).toString(16)}));this.getAnonymousId()||this.setAnonymousId(e),this.getDeviceId()||this.setDeviceId(e)},e}(),G=function(e){function r(t){var o=this,r={accountId:null,deviceId:null,anonymousId:null,sessionId:null,firstVisitTime:R(),props:{}};return(o=e.call(this,t,r)||this).options=t,o.storeName="hinasdk_crossdata",o.hLatestUtm={},o.hUtm={},o.customUtm={},o}return o(r,e),r.prototype.getUtmFromProps=function(t){for(var e in this.state.props){var o=this.state.props[e];e.startsWith("H_latest_")?this.hLatestUtm[e]=o:e.startsWith("H_")&&(this.hUtm[e]=o),t.includes(e)&&(this.customUtm[e]=o)}},r.prototype.init=function(){var e,o=new j,r=new F,n=new q;o.isSupport()?this.storage=o:(this.log("Cookie storage is not supported, SDK internal cache has been enabled",t.ConsoleTypes.WARN),this.storage=r),n.isSupport()?this.localStorage=n:this.log("localStorage is not supported, SDK internal cache has been enabled",t.ConsoleTypes.WARN),!(e=this.storage.get(this.storeName))&&this.localStorage&&(e=this.localStorage.get(this.storeName)),e&&function(t){try{JSON.parse(t)}catch(t){return!1}return!0}(e)?this.state=H(e):e=null,this.afterInit(e)},r.prototype.save=function(){this.storage.setDomain(this.storeName,JSON.stringify(this.state)),this.localStorage&&this.localStorage.set(this.storeName,JSON.stringify(this.state))},r.prototype.getCookie=function(){return this.storage.get(this.storeName)},r.prototype.setSessionId=function(t){this.set("sessionId",t)},r.prototype.getSessionId=function(){return this.state.sessionId||""},r.prototype.getSessionIdCreateTime=function(){var t=this.getSessionId().split("_")[0],e=Number(t);return Number.isNaN(e)?0:e},r}(J),$=function(){function t(){this.isReady=!1,this.isReady||this.init(),this.isReady=!0}return t.prototype.init=function(){this.os=this.getOs(),this.osVersion=this.getOsVersion();var t=this.getBrowser(),e=t.type,o=t.version;this.browserName=e,this.browserVersion=o,this.model=this.getModel()},t.prototype.getOs=function(){var t=navigator.userAgent;return/Windows/i.test(t)?/Phone/.test(t)||/WPDesktop/.test(t)?"Windows Phone":"Windows":/(iPhone|iPad|iPod)/.test(t)&&!window.MSStream?"iOS":/Android/.test(t)?"Android":/(BlackBerry|PlayBook|BB10)/i.test(t)?"BlackBerry":/Mac/i.test(t)?"Mac OS X":/Linux/.test(t)?"Linux":/CrOS/.test(t)?"Chrome OS":"取值异常"},t.prototype.getOsVersion=function(){var t=navigator.userAgent;if(/Windows/i.test(t)){var e=/Windows NT ([\d.]+)/;return t.match(e)?t.match(e)[1]:""}if(/(iPhone|iPad|iPod)/.test(t)&&!window.MSStream){e=/OS ([\d_]+)/;return t.match(e)?t.match(e)[1].replace(/_/g,"."):""}if(/Android/.test(t)){e=/Android ([\d.]+)/;return t.match(e)?t.match(e)[1]:""}if(/Mac/i.test(t)){e=/Mac OS X ([\d_]+)/;return t.match(e)?t.match(e)[1].replace(/_/g,"."):""}return""},t.prototype.getBrowser=function(){var t,e={type:"",version:""};try{var o=null===(t=navigator.userAgent)||void 0===t?void 0:t.toLowerCase(),r=[];if(null!==o.match(/baidubrowser/)?(e.type="baidu",r.push(/baidubrowser\/([\d.]+)/)):null!==o.match(/bidubrowser/)?(e.type="baidu",r.push(/bidubrowser\/([\d.]+)/)):null!==o.match(/edg/)?(e.type="edge",r.push(/edg\/([\d.]+)/)):null!==o.match(/edgios/)?(e.type="edge",r.push(/edgios\/([\d.]+)/)):null!==o.match(/liebaofast/)?(e.type="liebao",r.push(/liebaofast\/([\d.]+)/)):null!==o.match(/sogoumobilebrowser/)?(e.type="sogou",r.push(/sogoumobilebrowser\/([\d.]+)/)):null!==o.match(/lbbrowser/)?(e.type="liebao",r.push(/lbbrowser\/([\d.]+)/)):null!==o.match(/crios/)?(e.type="chrome",r.push(/crios\/([\d.]+)/)):null!==o.match(/qihoobrowser/)?(e.type="360",r.push(/qihoobrowser\/([\d.]+)/)):null!==o.match(/mxios/)?(e.type="maxthon",r.push(/mxios\/([\d.]+)/)):null!==o.match(/fxios/)?(e.type="firefox",r.push(/fxios\/([\d.\w]+)/)):null!==o.match(/edge/)?(e.type="edge",r.push(/edge\/([\d.]+)/)):null!==o.match(/metasr/)?(e.type="sogou",r.push(/metasr ([\d.]+)/)):null!==o.match(/micromessenger/)?(e.type="micromessenger",r.push(/micromessenger\/([\d.]+)/)):null!==o.match(/mqqbrowser/)?(e.type="qq",r.push(/mqqbrowser\/([\d.]+)/)):null!==o.match(/qqbrowserlite/)?(e.type="qq",r.push(/qqbrowserlite\/([\d.]+)/)):null!==o.match(/tencenttraveler/)?(e.type="qq",r.push(/tencenttraveler\/([\d.]+)/)):null!==o.match(/qqbrowser/)?(e.type="qq",r.push(/qqbrowser\/([\d.]+)/)):null!==o.match(/maxthon/)?(e.type="maxthon",r.push(/maxthon\/([\d.]+)/)):null!==o.match(/ubrowser/)?(e.type="uc",r.push(/ubrowser\/([\d.]+)/)):null!==o.match(/ucbrowser/)?(e.type="uc",r.push(/ucbrowser\/([\d.]+)/)):null!==o.match(/firefox/)?(e.type="firefox",r.push(/firefox\/([\d.]+)/)):null!==o.match(/opera/)?(e.type="opera",r.push(/opera\/([\d.]+)/)):null!==o.match(/opr/)?(e.type="opera",r.push(/opr\/([\d.]+)/)):null!==o.match(/chrome/)?(e.type="chrome",r.push(/chrome\/([\d.]+)/)):null!==o.match(/safari/)?(e.type="safari",r.push(/version\/([\d.]+)/)):null===o.match(/trident/)&&null===o.match(/msie/)||(e.type="ie"),"ie"===e.type){var n=o.match(/trident\/([\d.]+)/)?o.match(/trident\/([\d.]+)/)[1]:"",i=o.match(/msie ([\d.]+)/)?o.match(/msie ([\d.]+)/)[1]:"";""!==n?e.version=String(parseInt(n,10)+4):""!==i&&(e.version=i)}else r&&(e.version=o.match(r[0])?o.match(r[0])[1]:"")}catch(t){e.type="取值异常"}return e},t.prototype.getModel=function(){var t=navigator.userAgent;if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(t)){if(/iPhone|iPad|iPod/i.test(t))return t.match(/iPhone|iPad|iPod/i)[0];if(/Android/i.test(t))return t.match(/Android/i)[0]}var e=t.match(/Mac/);if(e)return e[0];var o=t.match(/Windows/);if(o)return o[0];var r=t.match(/Linux/);return r?r[0]:"取值异常"},t}();function X(){return document.documentElement.scrollTop||document.body.scrollTop||0}function Z(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||0}function Y(){return window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||0}var Q=function(){function t(t){this.visibleHandler=function(){},this.hiddenHandler=function(){};var e=t.visible,o=t.hidden;T(e)&&(this.visibleHandler=e),T(o)&&(this.hiddenHandler=o),this.init()}return t.prototype.isSupport=function(){return void 0!==document.hidden},t.prototype.init=function(){var t=this;this.isSupport()?document.addEventListener("visibilitychange",(function(){document.hidden?t.hiddenHandler():t.visibleHandler()})):(window.addEventListener("focus",this.visibleHandler),window.addEventListener("blur",this.hiddenHandler))},t}();var tt=function(){function t(t){this.options=t}return t.prototype.run=function(){var t=this;return new Promise((function(e){var o=t.options,r=o.imgUseCrossOrigin,n=o.url,i=o.data,a=new Image;r&&(a.crossOrigin="anonymous");var s=-1===n.indexOf("?")?"?":"&";a.src="".concat(n).concat(s).concat(i);var c=function(t){a=null,e({type:t})};a.onload=function(){c("success")},a.onerror=function(){c("success")}}))},t}(),et=function(){function t(t){this.options=t}return t.prototype.run=function(){var t=this;return new Promise((function(e){var o=t.options,r=o.url,n=o.data,i=o.timeout,a=o.credentials,s=o.contentType,c=o.customHeaders,u=void 0===c?{}:c,l=new XMLHttpRequest;l.open("POST",r,!0),l.timeout=i||2e4,l.isMonitor=!0,a&&(l.withCredentials=!0),l.setRequestHeader("Content-Type",s||"application/x-www-form-urlencoded"),b(u)&&!A(u)&&Object.keys(u).forEach((function(t){l.setRequestHeader(t,u[t])})),l.send(n||null),l.ontimeout=function(){l.abort()},l.onreadystatechange=function(){4===l.readyState&&(l.status>=200&&l.status<300||304===l.status?e({data:JSON.parse(l.responseText)||{},type:"success"}):e({type:"fail",msg:"网络异常, 请求失败，状态码=".concat(l.status)}))}}))},t}(),ot=function(){function t(t){this.options=t}return t.prototype.run=function(){var t=this;return new Promise((function(e){var o=t.options,r=o.url,n=o.data;navigator.sendBeacon&&e(navigator.sendBeacon(r,n)?{type:"success"}:{type:"fail",msg:"sendBeacon 请求失败"})}))},t}(),rt=function(){function e(t,e,o){void 0===e&&(e="hinasdk_tab"),void 0===o&&(o="hinasdk_data_"),this.options=t,this.batchKey=e,this.batchDataKey=o,this.isSending=!1,this.init()}return e.prototype.log=function(e,o){void 0===o&&(o=t.ConsoleTypes.LOG),this.options.showLog&&V(e,o)},e.prototype.init=function(){var e=new q;e.isSupport()?(this.localStorage=e,this.isSupport=!0):(this.isSupport=!1,this.log("批量发送功能需要使用localstorage存储数据，但是您的浏览器不支持localstorage，所以不能使用该功能",t.ConsoleTypes.WARN)),this.batchInterval()},e.prototype.getBatchConfig=function(){return this.options.batchSend},e.prototype.getStorageList=function(){if(!this.isSupport)return[];var t=[],e=this.localStorage.get(this.batchKey);return e&&(_(t=H(e))||(t=[])),t},e.prototype.batchInterval=function(){var t=this;if(this.isSupport){var e=this.getBatchConfig().sendInterval;setTimeout((function(){t.send().then((function(){t.batchInterval()}))}),e)}},e.prototype.send=function(){var t=this;return new Promise((function(e){var o=t.getStorageList();if(o.length>0&&t.isSupport){for(var r=t.getBatchConfig().dataSendTimeout,n=R(),i=[],a={},s=o.length,c=0;c<s;c++){var u=o[c],l=u.dataKey,p=u.expireTime;if(p>=n)a[l]={dataKey:l,expireTime:p},(y=t.localStorage.get(l))&&i.push(H(y));else t.localStorage.remove(l),o.splice(c,1),s--,c--}if(t.localStorage.set(t.batchKey,JSON.stringify(o)),0===i.length)e();else{var h=t.options,f=h.serverUrl,d=h.customHeaders,g=h.credentials,v=h.globalCallback,m=JSON.stringify(i),y=encodeURIComponent(W(m));t.isSending=!0,new et({url:f,data:"data_list=".concat(y),timeout:r,credentials:g,customHeaders:d}).run().then((function(o){T(v)&&v(f,i,o.type,o.msg||""),"success"===o.type&&t.remove(a),e(),t.isSending=!1}))}}else e()}))},e.prototype.remove=function(t){var e=this;if(this.isSupport){var o=this.getStorageList(),r=Object.keys(t);if(r.forEach((function(t){e.localStorage.remove(t)})),o.length===r.length)this.localStorage.set(this.batchKey,JSON.stringify([]));else{var n=o.filter((function(e){return!t[e.dataKey]}));this.localStorage.set(this.batchKey,JSON.stringify(n))}}},e.prototype.add=function(t){if(this.isSupport){var e,o,r=this.getBatchConfig(),n=r.sendInterval,i=r.storageLimit,a=this.batchDataKey+(e=R(),o=Math.floor(1e6*Math.random()),"".concat(e,"_").concat(o)),s=this.getStorageList();s.unshift({dataKey:a,expireTime:R()+2*n}),this.localStorage.set(this.batchKey,JSON.stringify(s)),this.localStorage.set(a,JSON.stringify(t)),!this.isSending&&(s.length>i||"track_signup"===t.type||"H_pageview"===t.event)&&this.send()}},e}();function nt(e,o){Object.keys(e).forEach((function(r){var n=e[r];if(S(n)&&n.length>o)V("属性 ".concat(r," 已经做截取")),e[r]=n.slice(0,o);else if(b(n))nt(n,o);else if(T(n))try{e[r]=n(e),T(e[r])?(V("属性--".concat(r," 格式不满足要求, 已被删除"),t.ConsoleTypes.WARN),delete e[r]):b(e[r])?nt(e[r],o):S(e[r])&&e[r].length>o&&(e[r]=e[r].slice(0,o))}catch(o){V("属性--".concat(r," 格式不满足要求, 已被删除"),t.ConsoleTypes.WARN),delete e[r]}}))}var it=["abtestExperimentId","paramName","valueType","defaultValue","callback","timeoutMilliseconds","customProperties","customIds"],at=function(e){function r(t,o,r,n,i){var a=e.call(this,t,o)||this;return a.options=t,a.context=o,a.name="AbtestBasePlugin",a.isReady=!1,a.platform="",a.storageName="",a.version="",a.projectKey="",a.platform=r,a.storageName=n,a.version=i,a}return o(r,e),r.prototype.init=function(){var e=this;if(this.context.store.localStorage){var o=this.options.abTestingPluginConfig,r=null==o?void 0:o.url;if(S(r)){var n=B(r,"project-key");if(n){if(this.projectKey=n,["Web","H5"].includes(this.platform)){var i=P(r).protocol,a=P(window.location.href).protocol;i&&i!==a&&this.context.log("A/B Testing 初始化失败，".concat(a," 页面必须使用 ").concat(a," 的 URL"),t.ConsoleTypes.WARN)}if(this.isReady)this.context.log("A/B Testing 插件已经运行，无需重复执行",t.ConsoleTypes.WARN);else{var s=this.context.getUserUid();this.context.log("当前accountId为：".concat(s),t.ConsoleTypes.INFO),K.on("changeAccountId",(function(){e.context.store.localStorage.set(e.storageName,"")})),this.isReady=!0}}else this.context.log("A/B Testing 初始化失败，请使用正确的 URL（必须包含 project-key）")}else this.context.log("A/B Testing 初始化失败，请使用正确的 URL！",t.ConsoleTypes.WARN)}else this.context.log("A/B Testing 初始化失败，浏览器不支持localStorage",t.ConsoleTypes.WARN)},r.prototype.transform=function(){},r.prototype.valueMatchType=function(e,o){switch(o){case t.VariablesTypes.INTEGER:return x(e);case t.VariablesTypes.STRING:return S(e);case t.VariablesTypes.BOOLEAN:return k(e);default:return!1}},r.prototype.normalizeParams=function(e,o,r){var n,i;void 0===r&&(r=it);var a={verify_success:!0,para:o};try{for(var s=u(r),c=s.next();!c.done;c=s.next()){var l=c.value;if(!a.verify_success)break;switch(l){case"abtestExperimentId":S(o.abtestExperimentId)&&o.abtestExperimentId.trim()||(this.context.log("".concat(e,"方法调用失败，").concat(l,"参数未正确配置！").concat(l,": ").concat(o.abtestExperimentId),t.ConsoleTypes.WARN),a.verify_success=!1);break;case"paramName":S(o.paramName)&&o.paramName.trim()||(this.context.log("".concat(e,"方法调用失败，").concat(l,"参数未正确配置！").concat(l,": ").concat(o.paramName),t.ConsoleTypes.WARN),a.verify_success=!1);break;case"valueType":[t.VariablesTypes.BOOLEAN,t.VariablesTypes.INTEGER,t.VariablesTypes.STRING].includes(o.valueType)||(this.context.log("".concat(e,"方法调用失败，").concat(l,"参数未正确配置！").concat(l,": ").concat(o.valueType),t.ConsoleTypes.WARN),a.verify_success=!1);break;case"defaultValue":this.valueMatchType(o.defaultValue,o.valueType)||(this.context.log("".concat(e,"方法调用失败，").concat(l,"类型必须与valueType一致！"),t.ConsoleTypes.WARN),a.verify_success=!1);break;case"callback":T(o.callback)||(this.context.log("".concat(e,"方法调用失败，").concat(l,"参数未正确配置")),o.callback=C,a.verify_success=!1);break;case"timeoutMilliseconds":(!x(o.timeoutMilliseconds)||o.timeoutMilliseconds<=0)&&(this.context.log("".concat(l,"参数错误：").concat(o.timeoutMilliseconds),t.ConsoleTypes.WARN),o.timeoutMilliseconds=3e3),o.timeoutMilliseconds<200&&(o.timeoutMilliseconds=200);break;case"customProperties":o.customProperties=b(o.customProperties)?o.customProperties:{};break;case"customIds":var p=o.customIds||{},h={};for(var f in p)(S(p[f])||x(p[f]))&&(h[f]=p[f]);o.customIds=h}}}catch(t){n={error:t}}finally{try{c&&!c.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}return a},r.prototype.sendTriggerEvent=function(t){var e=t.abtest_experiment_group_id,o=t.abtest_experiment_id;this.context.track("H_ABTestTrigger",{H_abtest_experiment_id:o,H_abtest_experiment_group_id:e})},r.prototype.getExpResult=function(t){return s(this,arguments,void 0,(function(t,e){var o,r,n,i,a,s,l,p,h,f,d,g,v,m,y;return void 0===e&&(e=[]),c(this,(function(c){switch(c.label){case 0:return o=t.abtestExperimentId,r=t.paramName,n=t.valueType,0!==e.length?[3,2]:[4,this.getStorageData()];case 1:b(a=c.sent())&&(e=a.result||[]),c.label=2;case 2:try{for(s=u(e),l=s.next();!l.done;l=s.next())if(p=l.value,h=p.abtest_experiment_id,f=p.abtest_experiment_group_id,d=p.is_white_list,g=p.variables,h===o&&(v=g.find((function(t){return t.name===r&&t.type===n})),v)){d||this.sendTriggerEvent({abtest_experiment_id:h,abtest_experiment_group_id:f}),i=v.value;break}}catch(t){m={error:t}}finally{try{l&&!l.done&&(y=s.return)&&y.call(s)}finally{if(m)throw m.error}}return[2,i]}}))}))},r.prototype.getStorageData=function(){return s(this,void 0,void 0,(function(){var t;return c(this,(function(e){switch(e.label){case 0:return[4,this.context.store.localStorage.get(this.storageName)];case 1:return(t=e.sent())?[2,H(t)]:[2,null]}}))}))},r.prototype.saveResponseData=function(t){return s(this,void 0,void 0,(function(){var e,o,r,n;return c(this,(function(i){switch(i.label){case 0:return[4,this.getStorageData()];case 1:return e=i.sent(),o={updateTime:R()},e&&b(e)?(r=[],n=e.result||[],t.forEach((function(t){var e=t.abtest_experiment_group_id,o=t.abtest_experiment_id,i=t.variables,a=n.find((function(t){return t.abtest_experiment_id===o&&t.abtest_experiment_group_id===e}));if(a){var s=[];i.forEach((function(t){var e=t.name,o=t.type,r=a.variables.findIndex((function(t){return t.name===e&&t.type===o}));r>=0?a.variables[r]=t:s.push(t)})),a.variables=p(p([],l(a.variables),!1),l(s),!1)}else r.push(t)})),o.result=p(p([],l(n),!1),l(r),!1)):o.result=t,this.context.store.localStorage.set(this.storageName,JSON.stringify(o)),[2]}}))}))},r.prototype.createRequestData=function(t){var e=t.paramName,o=t.customProperties,r=t.customIds,n={anonymous_id:this.context.store.getAnonymousId(),platform:this.platform,abtest_lib_version:this.version,param_name:e,properties:this.context.getPresetProperties()};return b(o)&&!A(o)&&(n.custom_properties=o),b(r)&&!A(r)&&(n.custom_ids=r),this.context.getUserUid()&&(n.login_id=this.context.getUserUid()),n},r.prototype.preFetch=function(e,o){return this.isReady?!!b(o)||(this.context.log("".concat(e," 方法参数必须是对象"),t.ConsoleTypes.WARN),!1):(this.context.log("A/B Testing 插件尚未运行，请先执行该插件",t.ConsoleTypes.WARN),!1)},r.prototype.asyncFetch=function(t){var e=this;return new Promise((function(o){e.getResultFromServer(t).then((function(t){o(t)})).catch((function(){t.callback(t.defaultValue)}))}))},r.prototype.asyncFetchABTest=function(t){var e=this;if(this.preFetch("asyncFetchABTest",t)){var o=this.normalizeParams("asyncFetchABTest",t),r=o.verify_success,n=o.para;r?this.asyncFetch(n).then((function(t){return s(e,void 0,void 0,(function(){var e;return c(this,(function(o){switch(o.label){case 0:return[4,this.getExpResult(n,t.results)];case 1:return e=o.sent(),n.callback(e||n.defaultValue),[2]}}))}))})):n.callback(n.defaultValue)}},r.prototype.fetchCacheABTest=function(t){return s(this,void 0,void 0,(function(){var e,o,r,n;return c(this,(function(i){switch(i.label){case 0:return this.preFetch("fetchCacheABTest",t)?(e=this.normalizeParams("fetchCacheABTest",t),o=e.verify_success,r=e.para,o?[4,this.getExpResult(r)]:[3,2]):[2];case 1:return n=i.sent(),r.callback(n||r.defaultValue),[3,3];case 2:r.callback(r.defaultValue),i.label=3;case 3:return[2]}}))}))},r.prototype.fastFetchABTest=function(t){return s(this,void 0,void 0,(function(){var e,o,r,n,i=this;return c(this,(function(a){switch(a.label){case 0:return this.preFetch("fastFetchABTest",t)?(e=this.normalizeParams("fastFetchABTest",t),o=e.verify_success,r=e.para,o?[4,this.getExpResult(r)]:[3,2]):[2];case 1:return w(n=a.sent())?r.callback(n):this.asyncFetch(r).then((function(){return s(i,void 0,void 0,(function(){var t;return c(this,(function(e){switch(e.label){case 0:return[4,this.getExpResult(r)];case 1:return t=e.sent(),r.callback(t||r.defaultValue),[2]}}))}))})),[3,3];case 2:r.callback(r.defaultValue),a.label=3;case 3:return[2]}}))}))},r}(h),st=function(){function e(t,e){void 0===e&&(e=!0),this.isReady=!1,this.consolePrefix="埋点SDK",this.useInstancing=!0,this.plugins=[],this.options=t,this.useInstancing=e}return e.prototype.log=function(e,o){void 0===o&&(o=t.ConsoleTypes.LOG),this.options.showLog&&("string"==typeof e&&this.consolePrefix&&(e="".concat(this.consolePrefix,"：").concat(e)),V(e,o))},e.prototype.runPlugins=function(t){var e=this;t.forEach((function(t){t.disabled||t.init((function(o){if(t.transform){var r=t.transform(o);r&&e.report(r)}}))}))},e.prototype.applyPlugins=function(e){var o=this;if(this.isReady){_(e)||(e=[e]);var r=[];e.forEach((function(t){var e=new t(o.options,o);o.plugins.push(e),r.push(e)})),this.runPlugins(r)}else this.log("请先初始化SDK实例",t.ConsoleTypes.WARN)},e}(),ct=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return o(r,e),r.prototype.sendReportData=function(e,o,r){var n=this.options,i=n.batchSend,a=n.globalCallback,s=n.serverUrl,c=n.dataSendTimeout,u=n.sendType,l=n.customHeaders,p=n.credentials,h=n.imgUseCrossOrigin;if(u=r||u,s){if(b(e)&&!A(e))if(i)this.batchSender.add(e);else{var f=e;S(e)||(f=function(t){try{return JSON.stringify(t)}catch(e){return t}}(e));var d=W(f),g={data:"data=".concat(encodeURIComponent(d)),url:s,timeout:c,imgUseCrossOrigin:h,customHeaders:l,credentials:p};(u===t.ReportTypes.BEACON&&navigator.sendBeacon?new ot(g):u===t.ReportTypes.IMAGE&&g.data.length<2048?new tt(g):new et(g)).run().then((function(t){return T(a)&&a(s,e,t.type,t.msg||""),T(o)&&o(s,e,t.type,t.msg||""),t}))}}else this.log("当前 serverUrl 为空，network 中不会发数据，请配置正确的 serverUrl！",t.ConsoleTypes.WARN)},r}(st);function ut(t){return 1===(null==t?void 0:t.nodeType)}function lt(t,e){var o;if("input"===(null===(o=t.tagName)||void 0===o?void 0:o.toLowerCase()))return(["button","submit"].includes(t.type)||e)&&t.value||"";var r="";return t.textContent?r=t.textContent.trim():t.innerText&&(r=t.innerText.trim()),r&&(r=r.replace(/[\r\n]/g," ").replace(/[ ]+/g," ").substring(0,255)),r||""}function pt(t,e){var o;if(!ut(t))return{};var r,n={H_element_type:null===(o=t.tagName)||void 0===o?void 0:o.toLowerCase(),H_element_name:t.getAttribute("name"),H_element_id:t.getAttribute("id"),H_element_target_url:t.getAttribute("href"),H_element_class_name:t.classList.value||t.className,H_element_content:lt(t,e)};return r=n,Object.keys(r).reduce((function(t,e){return w(r[e])&&""!==r[e]&&(t[e]=r[e]),t}),{})}function ht(t,e){if(!t)return{};var o=document.documentElement.scrollLeft||document.body.scrollLeft||0,r=X(),n=e.getBoundingClientRect(),i=t.pageX||t.clientX+o||t.offsetX+((null==n?void 0:n.left)||0)+o,a=t.pageY||t.clientY+r||t.offsetY+((null==n?void 0:n.top)||0)+r;return{H_page_x:N(i,3),H_page_y:N(a,3)}}var ft=["mark","/mark","strong","b","em","i","u","abbr","ins","del","s","sup"],dt=["a","input","button","textarea"],gt=function(e){function r(t,o){var r=e.call(this,t,o)||this;return r.options=t,r.context=o,r.name="ClickTrackPlugin",r.isReady=!1,r.isTrackList={a:!0,button:!0},r}return o(r,e),r.prototype.init=function(e){var o=this,r=this.options.autoTrackConfig,n=r.clickAutoTrack,i=r.isCollectUrl,a=r.isCollectElement,s=r.addCustomProperty;!0===n&&(this.isReady?this.context.log("ClickTrack plugin：插件已经运行，无需重复执行",t.ConsoleTypes.WARN):(this.isReady=!0,document.addEventListener("click",(function(t){if(i()){var r=t||window.event;if(r){var n=r.target||r.srcElement,c=o.getTargetElement(n);if(c){if(T(a)&&!a(c))return!1;var u=o.getClickElementInfo(c),l=ht(r,c),p=l.H_page_x,h=l.H_page_y;u.H_page_x=p,u.H_page_y=h;var f=o.getElementPosition(c,u.H_element_path);if(x(f)&&f>=0&&(u.H_element_position=f),T(s)){var d=s(c);b(d)&&(u=I(u,d))}e(u)}}}}),!0)))},r.prototype.transform=function(t){return this.context.getReportData("track","H_WebClick",t)},r.prototype.hasAttribute=function(t,e){var o;return t.hasAttribute?t.hasAttribute(e):t.attributes?!!(null===(o=t.attributes[e])||void 0===o?void 0:o.value):void 0},r.prototype.hasAttributes=function(t,e){if(_(e))for(var o=0;o<e.length;o++)if(this.hasAttribute(t,e[o]))return!0;return!1},r.prototype.hasElement=function(t){var e,o,r,n=function(t){var e=[t];try{if(!ut(t))return e;if(null===t||null===t.parentElement)return e;for(;null!==t.parentElement;)t=t.parentElement,e.push(t);return e}catch(t){}return e}(t),i=this.options.autoTrackConfig.trackAttr||[];if(_(n)&&n.length>0)try{for(var a=u(n),s=a.next();!s.done;s=a.next()){var c=s.value,l=c.tagName&&(null===(r=c.tagName)||void 0===r?void 0:r.toLowerCase());if(ut(c)&&(this.isTrackList[l]||this.hasAttributes(c,i)))return c}}catch(t){e={error:t}}finally{try{s&&!s.done&&(o=a.return)&&o.call(a)}finally{if(e)throw e.error}}},r.prototype.getDivMaxLevel=function(){var t;return(null===(t=this.options.autoTrackConfig.collectTags.div)||void 0===t?void 0:t.maxLevel)||1},r.prototype.isStyleTag=function(t){var e,o=(null===(e=this.options.autoTrackConfig.collectTags.div)||void 0===e?void 0:e.ignoreTags)||[];return null==o?void 0:o.includes(t)},r.prototype.getCollectableParent=function(e){var o;try{var r=e.parentNode,n=r?null===(o=r.tagName)||void 0===o?void 0:o.toLowerCase():"";if("body"===n)return!1;var i=this.getDivMaxLevel();if("div"===n&&(i>1||this.isCollectableDiv(r)))return r;if(r&&this.isStyleTag(n))return this.getCollectableParent(r)}catch(e){this.context.log(e,t.ConsoleTypes.ERROR)}return!1},r.prototype.isCollectableDiv=function(e){var o;try{var r=e.children||[];if(0===r.length)return!0;for(var n=0;n<r.length;n++){var i=r[n];if(ut(i)){var a=null===(o=i.tagName)||void 0===o?void 0:o.toLowerCase(),s=this.getDivMaxLevel();if(!("div"===a&&s>1||this.isStyleTag(a)))return!1;if(!this.isCollectableDiv(i))return!1}}return!0}catch(e){this.context.log(e,t.ConsoleTypes.ERROR)}return!1},r.prototype.isDivLevelValid=function(t){for(var e=this.getDivMaxLevel(),o=t.getElementsByTagName("div"),r=o.length-1;r>=0;r--)if(this.getDivLevels(o[r],t)>e)return!1;return!0},r.prototype.getElementPath=function(t,e,o){for(var r,n,i=[];ut(t)&&t.parentNode;){if(t.id&&!e&&/^[A-Za-z][-A-Za-z0-9_:.]*$/.test(t.id)){var a=t.tagName||"";i.unshift("".concat(a.toLowerCase(),"#").concat(t.id));break}if(o&&t===o){i.unshift(null===(r=t.tagName)||void 0===r?void 0:r.toLowerCase());break}if(t===document.body){i.unshift("body");break}i.unshift(null===(n=t.tagName)||void 0===n?void 0:n.toLowerCase()),t=t.parentNode}return i.join(" > ")},r.prototype.getDivLevels=function(t,e){var o=this.getElementPath(t,!0,e).split(" > "),r=0;return o.forEach((function(t){"div"===t&&r++})),r},r.prototype.getTargetElement=function(t){var e;if(!ut(t))return null;var o=null===(e=t.tagName)||void 0===e?void 0:e.toLowerCase();if(!S(o))return null;if(["body","html"].includes(o))return null;if(this.context.trackTags.includes(o)&&"div"!==o)return t;if("div"===o&&this.options.autoTrackConfig.collectTags.div&&(this.isDivLevelValid(t)&&(this.getDivMaxLevel()>1||this.isCollectableDiv(t))))return t;if(this.options.autoTrackConfig.collectTags.div&&this.isStyleTag(o)){var r=this.getCollectableParent(t);if(r&&this.isDivLevelValid(r))return r}return this.hasElement(t)||null},r.prototype.getClickElementInfo=function(t){var e=this.options.autoTrackConfig.isCollectInput,o=!1;T(e)&&(o=e(t));var r=this.getDomSelector(t),n=pt(t,o);return n.H_element_selector=r,n.H_element_path=this.getElementPath(t,!1),n},r.prototype.getDomSelector=function(t){for(var e,o=[];t;){if("body"===(null===(e=t.tagName)||void 0===e?void 0:e.toLowerCase())||!ut(t)){o.unshift("body");break}if(o.unshift(this.getSelector(t)),(null==t?void 0:t.getAttribute("id"))&&/^[A-Za-z][-A-Za-z0-9_:.]*$/.test(t.getAttribute("id")))break;t=t.parentNode}return o.join(" > ")},r.prototype.getSelector=function(t){var e,o,r=null===(e=t.tagName)||void 0===e?void 0:e.toLowerCase(),n=-1;9!==(null===(o=t.parentNode)||void 0===o?void 0:o.nodeType)&&(n=this.getDomIndex(t));var i=t.getAttribute("id");return i&&/^[A-Za-z][-A-Za-z0-9_:.]*$/.test(i)?"#".concat(i):r+(n>-1?":nth-of-type(".concat(n+1,")"):"")},r.prototype.getDomIndex=function(t){var e,o;if(t.parentNode)for(var r=0,n=null===(e=t.tagName)||void 0===e?void 0:e.toLowerCase(),i=t.parentNode.children,a=0;a<i.length;a++){var s=i[a];if((null===(o=s.tagName)||void 0===o?void 0:o.toLowerCase())===n){if(s===t)return r;r++}}return-1},r.prototype.getClosestLi=function(t){for(;t&&t!==document&&ut(t);){if("li"===t.tagName.toLowerCase())return t;t=t.parentNode}return null},r.prototype.getSameTypeSiblings=function(t){for(var e,o,r=t.parentNode,n=null===(e=t.tagName)||void 0===e?void 0:e.toLowerCase(),i=[],a=0;a<r.children.length;a++){var s=r.children[a];ut(s)&&(null===(o=s.tagName)||void 0===o?void 0:o.toLowerCase())===n&&i.push(s)}return i},r.prototype.getElementPosition=function(t,e){var o,r=this.getClosestLi(t);if(!r||!ut(t)||!S(t.tagName))return null;var n=null===(o=t.tagName)||void 0===o?void 0:o.toLowerCase(),i=r.getElementsByTagName(n),a=i.length;if(a>1){for(var s=[],c=0;c<a;c++){this.getElementPath(i[c],!1)===e&&s.push(i[c])}if(s.length>0)return s.findIndex((function(e){return e===t}))}if(!r.parentNode)return-1;var u=this.getSameTypeSiblings(r);return 1===u.length?0:u.findIndex((function(t){return t===r}))},r}(h),vt=function(e){function r(t,o){var r=e.call(this,t,o)||this;return r.options=t,r.context=o,r.name="StayTrackPlugin",r.isReady=!1,r.timer=null,r.previousTime=R(),r.previousOffsetTop=0,r}return o(r,e),r.prototype.init=function(e){var o=this,r=this.options,n=r.autoTrackConfig,i=r.stayAutoTrackConfig;if(!0===n.stayAutoTrack)if(this.isReady)this.context.log("StayTrack plugin：插件已经运行，无需重复执行",t.ConsoleTypes.WARN);else{this.isReady=!0;var a=i.isCollectUrl;T(a)||(a=function(){return!0}),this.timer&&(clearTimeout(this.timer),this.timer=null),this.previousTime=R(),window.addEventListener("load",(function(){o.previousOffsetTop=X()})),window.addEventListener("scroll",(function(){a()&&(o.timer||(o.timer=setTimeout((function(){o.run(e),clearTimeout(o.timer),o.timer=null}),1e3)))})),window.addEventListener("unload",(function(){a()&&o.run(e,!0)}))}},r.prototype.transform=function(t){return this.context.getReportData("track","H_WebStay",t)},r.prototype.run=function(t,e){void 0===e&&(e=!1);var o=this.options.autoTrackConfig,r=o.stayDelayTime,n=o.maxStayPageDuration,i=X(),a=R(),s=a-this.previousTime;(e||s>r&&i!==this.previousOffsetTop)&&t({H_viewport_width:Y(),H_viewport_height:Z(),H_viewport_position:this.previousOffsetTop,event_duration:Math.min(s/1e3,n),H_url_path:window.location.pathname});this.previousTime=a,this.previousOffsetTop=i},r}(h),mt=function(e){function r(t,o){var r=e.call(this,t,o)||this;return r.options=t,r.context=o,r.name="PageLeave",r.isReady=!1,r.pageId=U(),r.storageName="hinasdk_pageleave_",r.heartbeatIntervalTime=5e3,r.maxDuration=432e3,r.heartbeatIntervalTimer=null,r.startTime=R(),r.url=window.location.href,r.pageShowStatus=!0,r}return o(r,e),r.prototype.init=function(){if(this.options.autoTrackConfig.pageLeaveAutoTrack)if(this.context.store.localStorage)if(this.isReady)this.context.log("PageLeave plugin：插件已经运行，无需重复执行",t.ConsoleTypes.WARN);else{this.isReady=!0;var e=this.normalizePageLeaveAutoTrack(),o=e.heartbeat_interval_time,r=e.max_duration;o&&o>0&&(this.heartbeatIntervalTime=1e3*o),r&&r>0&&(this.maxDuration=Number(r)),this.startTime=R(),this.addPageLeaveEventListener(),document.hidden?this.pageShowStatus=!1:this.startHeartBeatInterval()}else this.context.log("PageLeave plugin需要使用localstorage存储数据，但是您的浏览器不支持localstorage，所以不能使用该功能",t.ConsoleTypes.WARN)},r.prototype.transform=function(){},r.prototype.normalizePageLeaveAutoTrack=function(){var t=this.options.autoTrackConfig.pageLeaveAutoTrack;return b(t)?t:{}},r.prototype.addPageLeaveEventListener=function(){this.addPageStartListener(),this.addPageSwitchListener(),this.addSinglePageListener(),this.addPageEndListener()},r.prototype.addPageStartListener=function(){var t=this;"onpageshow"in window&&window.addEventListener("pageshow",(function(){t.pageStartHandler()}))},r.prototype.addPageSwitchListener=function(){var t=this;new Q({visible:function(){t.pageStartHandler(),t.startHeartBeatInterval()},hidden:function(){t.url=window.location.href,t.pageEndHandler(),t.stopHeartBeatInterval()}})},r.prototype.addSinglePageListener=function(){var t=this;K.on("urlChange",(function(e){var o=e.fromHref;o!==e.toHref&&(t.url=o,t.pageEndHandler(),t.stopHeartBeatInterval(),t.pageStartHandler(),t.startHeartBeatInterval())}))},r.prototype.addPageEndListener=function(){var t=this,e=["pagehide","beforeunload","unload"];e.forEach((function(o){"on".concat(e)in window&&window.addEventListener(o,(function(){t.pageEndHandler(),t.stopHeartBeatInterval()}))}))},r.prototype.pageStartHandler=function(){this.startTime=R(),this.pageShowStatus=!document.hidden,this.url=window.location.href},r.prototype.pageEndHandler=function(){if(this.pageShowStatus){if(this.pageShowStatus=!1,this.isCollectUrl()){var t=this.getPageLeaveProperties(),e=this.context.getReportData("track","H_WebPageLeave",t);this.context.report(e)}this.delHeartBeatData()}},r.prototype.startHeartBeatInterval=function(){var t=this;this.heartbeatIntervalTimer&&this.stopHeartBeatInterval(),this.isCollectUrl()&&(this.heartbeatIntervalTimer=setInterval((function(){t.saveHeartBeatData()}),this.heartbeatIntervalTime),this.saveHeartBeatData("first_heartbeat")),this.reissueHeartBeatData()},r.prototype.reissueHeartBeatData=function(){for(var t=this.context.store.localStorage,e=t.length(),o=0;o<e;o++){var r=t.key(o);if(r&&r!==this.storageName+this.pageId&&r.includes(this.storageName)){var n=H(t.get(r));b(n)&&R()-n.time>n.heartbeat_interval_time+5e3&&(delete n.heartbeat_interval_time,this.context.report(n)),this.delHeartBeatData(r)}}},r.prototype.stopHeartBeatInterval=function(){this.heartbeatIntervalTimer&&(clearInterval(this.heartbeatIntervalTimer),this.heartbeatIntervalTimer=null)},r.prototype.delHeartBeatData=function(t){this.context.store.localStorage.remove(t||this.storageName+this.pageId)},r.prototype.isCollectUrl=function(){var t=this.normalizePageLeaveAutoTrack().isCollectUrl;return!T(t)||t(this.url)},r.prototype.saveHeartBeatData=function(t){var e=this.getPageLeaveProperties();e.H_time=R(),"first_heartbeat"===t&&(e.event_duration=3);var o=this.context.getReportData("track","H_WebPageLeave",e);o.heartbeat_interval_time=this.heartbeatIntervalTime,this.context.store.localStorage.set(this.storageName+this.pageId,JSON.stringify(o))},r.prototype.getPageLeaveProperties=function(){var t=(R()-this.startTime)/1e3;t=t<=0||t>this.maxDuration?0:N(t,3);var e=P(this.url),o=e.pathname,r=e.hash,n=O(),i={H_url:this.url,H_url_path:o,H_url_hash:r,H_viewport_position:X(),H_referrer:n,H_referrer_host:n?D(n):"",event_duration:t},s=this.normalizePageLeaveAutoTrack().custom_props;return b(s)&&(i=a(a({},i),s||{})),i},r}(h),yt=function(e){function r(t,o){var r=e.call(this,t,o)||this;return r.options=t,r.context=o,r.name="SiteLinker",r.isReady=!1,r.linker=[],r}return o(r,e),r.prototype.init=function(){if(this.options.siteLinkerConfig){var e=this.getLinkerConfig().linker;_(e)&&e.length>0?this.isReady?this.context.log("SiteLinker plugin：插件已经运行，无需重复执行",t.ConsoleTypes.WARN):(this.isReady=!0,this.resolveOption(),this.setRefferId(),this.addClickListen()):this.context.log("siteLinker plugin: 请配置正确的linker参数",t.ConsoleTypes.WARN)}},r.prototype.transform=function(){},r.prototype.getLinkerConfig=function(){var t=this.options.siteLinkerConfig||{},e=t.linker;return{linker:(void 0===e?[]:e)||[],re_login:t.re_login}},r.prototype.resolveOption=function(){for(var e=this.getLinkerConfig().linker,o=e.length,r=[],n=0;n<o;n++){var i=e[n],a=i.part_url,s=i.after_hash;/[A-Za-z0-9]+\./.test(a)&&k(s)?r.push({part_url:a,after_hash:s}):this.context.log("The configuration of linker ".concat(n+1," is not supported.Please check format"),t.ConsoleTypes.WARN)}this.linker=r},r.prototype.setRefferId=function(){var t=this.getLinkerConfig().re_login,e=this.getUrlId(),o=e.startsWith("a");if(""!==(e=e.substring(1))){var r=this.context.store.getAnonymousId(),n=this.context.store.getAccountId();if(o){if(e!==r&&(this.context.store.state.anonymousId=e,this.context.store.save()),n){var i=this.context.getReportData("track_signup","H_SignUp",{});this.context.report(i)}}else(!n||t&&n!==e)&&this.context.setUserUId(e)}},r.prototype.getUrlId=function(){var t=window.location.href.match(/_hnsdk=([au][^\?\#\&\=]+)/);return _(t)&&t[1]?function(t){var e=t;try{e=decodeURIComponent(t)}catch(t){}return e}(t[1]):""},r.prototype.getPartUrl=function(t){for(var e=this.linker.length,o=0;o<e;o++)if(t.includes(this.linker[o].part_url))return!0;return!1},r.prototype.getPartHash=function(t){for(var e=this.linker.length,o=0;o<e;o++)if(t.includes(this.linker[o].part_url))return this.linker[o].after_hash;return!1},r.prototype.getCurrentId=function(){var t=this.context.store.getAccountId(),e=this.context.store.getAnonymousId();return function(t){var e=t;try{e=encodeURIComponent(t)}catch(t){}return e}(t?"u".concat(t):"a".concat(e))},r.prototype.rewriteUrl=function(t,e){var o=function(t,e,o){var r=/([^?#]+)(\?[^#]*)?(#.*)?/.exec(t),n="";if(r){var i=r[1]||"",a=r[2]||"",s=r[3]||"",c="_hnsdk=".concat(e),u=function(t){var e=t.split("&"),o=[];return e.forEach((function(t){t.includes("_hnsdk")?o.push(c):o.push(t)})),o.join("&")};if(o){var l=s.includes("?"),p=s.indexOf("_hnsdk");n=l?p>=0?"".concat(i).concat(a,"#").concat(s.substring(1,p)).concat(u(s.substring(p,s.length))):"".concat(i).concat(a,"#").concat(s.substring(1),"&").concat(c):"".concat(i).concat(a,"#").concat(s.substring(1),"?").concat(c)}else n=(l=/^\?(\w)+/.test(a))?a.includes("_hnsdk")?"".concat(i,"?").concat(u(a.substring(1))).concat(s):"".concat(i).concat(a,"&").concat(c).concat(s):"".concat(i,"?").concat(c).concat(s);return n}}(t,this.getCurrentId(),this.getPartHash(t));return e&&(e.href=o),o},r.prototype.addClickListen=function(){var t=this,e=function(e){var o,r,n=e.target;if(n){var i=null===(o=n.tagName)||void 0===o?void 0:o.toLowerCase(),a=n.parentNode,s=null===(r=null==a?void 0:a.tagName)||void 0===r?void 0:r.toLowerCase();if("a"===i&&n.href||"a"===s&&a.href){var c=void 0,u=void 0;"a"===i&&n.href?(c=n.href,u=n):(c=a.href,u=a);var l=P(c).protocol;"http:"!==l&&"https:"!==l||t.getPartUrl(c)&&t.rewriteUrl(c,u)}}};"PointerEvent"in window?document.addEventListener("pointerdown",e):document.addEventListener("mousedown",e)},r}(h),bt=function(e){function r(t,o){var r=e.call(this,t,o)||this;return r.options=t,r.context=o,r.name="HistoryPlugin",r.isReady=!1,r.lastHref=window.location.href,r.lastPath=window.location.pathname,r}return o(r,e),r.prototype.init=function(){if(window&&window.history.pushState&&window.history.replaceState)if(this.isReady)this.context.log("History plugin：插件已经运行，无需重复执行",t.ConsoleTypes.WARN);else{this.isReady=!0;var e=this,o=window.onpopstate,r=function(t,o){var r={fromPath:e.lastPath,fromHref:e.lastHref,toPath:t,toHref:o};e.lastPath=t,e.lastHref=o,K.emit("urlChange",a(a({},r),{mode:"history"}))};window.onpopstate=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=window.location.pathname,i=window.location.href;r(n,i),o&&o.apply(this,t)},M(window.history,"pushState",n),M(window.history,"replaceState",n)}function n(t){return function(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];t.apply(this,e);var n=window.location.pathname,i=window.location.href;r(n,i)}}},r.prototype.transform=function(){},r}(h),wt=function(e){function r(t,o){var r=e.call(this,t,o)||this;return r.options=t,r.context=o,r.name="HashPlugin",r.isReady=!1,r.lastHref=window.location.href,r.lastPath=window.location.hash,r}return o(r,e),r.prototype.init=function(){var e=this;this.isReady?this.context.log("Hash plugin：插件已经运行，无需重复执行",t.ConsoleTypes.WARN):(this.isReady=!0,window.addEventListener("hashchange",(function(t){var o=t.newURL,r=P(o).hash,n={fromPath:e.lastPath,fromHref:e.lastHref,toPath:r,toHref:o};e.lastHref=o,e.lastPath=r,K.emit("urlChange",a(a({},n),{mode:"hash"}))})))},r.prototype.transform=function(){},r}(h),_t="4.0.4",Tt=function(t){function e(e,o){var r,n,i=this,a=(n=null===(r=navigator.userAgent)||void 0===r?void 0:r.toLowerCase(),/android|webos|iphone|ipod|blackberry/i.test(n)?"H5":"Web");return(i=t.call(this,e,o,a,"hina_webjs_sdk_abtest",_t)||this).options=e,i.context=o,i.name="HinaABTest",i}return o(e,t),e.prototype.getResultFromServer=function(t){var e=this;return new Promise((function(o,r){var n=e.createRequestData(t);new et({url:e.options.abTestingPluginConfig.url,data:JSON.stringify(n),contentType:"application/json",customHeaders:{"project-key":e.projectKey},timeout:t.timeoutMilliseconds}).run().then((function(t){var n=t.data;"SUCCESS"===(null==n?void 0:n.status)?e.saveResponseData(n.results).then((function(){o(n)})):r()}))}))},e}(at),St=function(){function t(){}return t.getSourceFromReferrer=function(){var t=function(t,e){for(var o=0;o<t.length;o++)if(-1!==e.split("?")[0].indexOf(t[o]))return!0},e="(".concat(f.join("|"),")\\=[^&]+"),o=document.referrer||"",r=window.location.href;if(r){var n=r.match(new RegExp(e));return n&&n[0]?"付费广告流量":t(d,o)?"自然搜索流量":t(g,o)?"社交网站流量":""===o?"直接流量":"引荐流量"}return"获取url异常"},t.getReferSearchEngine=function(t){var e,o,r=D(t);if(!r||"hostname解析异常"===r)return"";var n={baidu:[/^.*\.baidu\.com$/],bing:[/^.*\.bing\.com$/],google:[/^www\.google\.com$/,/^www\.google\.com\.[a-z]{2}$/,/^www\.google\.[a-z]{2}$/],sm:[/^m\.sm\.cn$/],so:[/^.+\.so\.com$/],sogou:[/^.*\.sogou\.com$/],yahoo:[/^.*\.yahoo\.com$/]};for(var i in n){var a=n[i];try{for(var s=(e=void 0,u(a)),c=s.next();!c.done;c=s.next()){if(c.value.test(r))return i}}catch(t){e={error:t}}finally{try{c&&!c.done&&(o=s.return)&&o.call(s)}finally{if(e)throw e.error}}}return"未知搜索引擎"},t.getKeywordFromReferrer=function(){var t=document.referrer||"";if(0===t.indexOf("http")){var e=this.getReferSearchEngine(t),o=function(t){t=t||"";var e={};return new URLSearchParams(t).forEach((function(t,o){e[o]=t})),e}(P(t).search);if(A(o))return"未取到值";for(var r in v){var n=v[r];if(r===e)if(_(n))for(var i=0;i<n.length;i++){var a=o[n[i]];if(a)return a}else if(o[n])return o[n]}return"未取到值"}return""===t?"未取到值_直接打开":"未取到值_非http的url"},t}();function xt(t){void 0===t&&(t="");var e,o=(e={},f.forEach((function(t){var o=B(window.location.href,t);o.length&&(e[t]=o)})),e),r={};return Object.keys(o).forEach((function(e){r[t+e]=o[e]})),r}var kt=function(e){function r(t,o){void 0===o&&(o=!0);var r=e.call(this,t,o)||this;return r.trackTags=dt,r.customProperties={},r.generalProperties={H_lib_version:_t,H_lib:"js",H_lib_method:"code",H_timezone_offset:(new Date).getTimezoneOffset()},r.useInstancing&&r.init(t),r}return o(r,e),r.prototype.init=function(e){if(this.isReady)this.log("hinaSDK has been initialized",t.ConsoleTypes.ERROR);else{var o={name:"",serverUrl:"",showLog:!1,autoTrackConfig:{clickAutoTrack:!0,stayAutoTrack:!0,isCollectUrl:function(){return!0},isCollectElement:function(){return!0},isCollectInput:function(){return!1},addCustomProperty:function(){},stayDelayTime:4e3,maxStayPageDuration:18e3,collectTags:{div:!1},trackAttr:["hn-click"],pageviewAutoTrack:!1,pageLeaveAutoTrack:!1},stayAutoTrackConfig:{isCollectUrl:function(){return!0}},maxStringLength:1024,imgUseCrossOrigin:!1,isSinglePage:!1,batchSend:!1,appJsBridge:!1,sendType:t.ReportTypes.BEACON,customHeaders:{},credentials:!1,dataSendTimeout:3e3,presetProperties:{latest_utm:!0,latest_traffic_source_type:!0,latest_search_keyword:!0,latest_referrer:!0},sourceChannel:[],plugins:[]},r=e.performanceErrorConfig,n=e.plugins,i=function(t,e){var o={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(o[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(t);n<r.length;n++)e.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(t,r[n])&&(o[r[n]]=t[r[n]])}return o}(e,["performanceErrorConfig","plugins"]);this.options=I(o,i),this.options=a(a({},this.options),{performanceErrorConfig:r,plugins:n}),this.initState(),this.initAdvProps(),this.normalizeConfig(),this.initPlugins(),this.isReady=!0}},r.prototype.normalizeConfig=function(){var e=this,o=this.options,r=o.serverUrl,n=o.sendType,i=o.batchSend,s=o.maxStringLength,c=o.isSinglePage,u=o.autoTrackConfig,l=void 0===u?{}:u,p=l.trackAttr,h=void 0===p?[]:p,f=l.collectTags,d=l.pageLeaveAutoTrack,g=l.pageviewAutoTrack;if(""===(r=(r=r||"").trim()))this.log("当前 serverUrl 为空，network 中不会发数据，请配置正确的 serverUrl！",t.ConsoleTypes.WARN);else{var v=P(window.location.href).protocol||"";(P(r).protocol||"")!==v&&this.log("SDK 检测到您的数据发送地址和当前页面地址的协议不一致，建议您修改成一致的协议。因为：https 下面发送 http 的图片请求会失败。",t.ConsoleTypes.WARN)}if([t.ReportTypes.IMAGE,t.ReportTypes.AJAX,t.ReportTypes.BEACON].includes(n)||this.setConfig({sendType:t.ReportTypes.AJAX}),this.options.maxStringLength=function(t){var e=t;return!x(t)||t<0?e=1024:t>5120&&(e=5120),e}(s),(!0===d||b(d)&&A(d))&&(this.options.autoTrackConfig.pageLeaveAutoTrack={heartbeat_interval_time:5e3,max_duration:432e3}),_(h)?(h=h.filter((function(t){return S(t)}))).includes("hn-click")||h.push("hn-click"):h=["hn-click"],this.options.autoTrackConfig.trackAttr=h,b(f))if(!0===f.div)this.options.autoTrackConfig.collectTags.div={ignoreTags:ft,maxLevel:1};else if(b(f.div)){var m=1,y=f.div;x(y.maxLevel)&&[1,2,3].includes(y.maxLevel)&&(m=y.maxLevel),this.options.autoTrackConfig.collectTags.div={ignoreTags:ft,maxLevel:m}}else this.options.autoTrackConfig.collectTags.div=!1;else this.options.autoTrackConfig.collectTags={div:!1};this.updateTrackTags(),(!0===i||b(i)&&!A(i))&&(this.options.batchSend=a({dataSendTimeout:6e3,sendInterval:6e3,storageLimit:200},i),this.batchSender=new rt(this.options,"hinasdk_tab","hinasdk_data_")),"auto"===g?this.autoTrack():("singlePage"===g||c)&&(this.autoTrack(),K.on("urlChange",(function(t){var o=t.fromHref;if(o!==t.toHref){var r={};if(T(c)){var n=c();b(n)&&(r=a(a({},r),n))}e.autoTrack(a(a({},r),{H_referrer:o}))}})))},r.prototype.updateTrackTags=function(){var t=this.options.autoTrackConfig.collectTags,e=p([],l(dt),!1);Object.keys(t||{}).forEach((function(o){var r=t[o];!0!==r&&!b(r)||e.includes(o)||e.push(o)})),this.trackTags=e},r.prototype.initState=function(){this.store=new G(this.options),this.store.init()},r.prototype.initAdvProps=function(){var t,e={},o=this.options,r=o.presetProperties,n=o.sourceChannel;if(b(r))for(var i in r){var s=r[i];if(i.includes("latest_")&&(i=i.slice(7),s)){var c=E();if("utm"!==i&&"url解析失败"===c)e["H_latest_".concat(i)]="url的domain解析失败";else if(""===(t=(t=void 0)||document.referrer)||L(D(t))!==L())switch(i){case"traffic_source_type":e.H_latest_traffic_source_type=St.getSourceFromReferrer();break;case"search_keyword":var u=St.getKeywordFromReferrer();u&&(e.H_latest_search_keyword=u);break;case"referrer":e.H_latest_referrer=O()}}}var l=this.store.state.props||{},p={};r.latest_utm&&(p=xt("H_latest_"));var h={};l.H_utm_source||(h=xt("H_"));var d=[],g={};_(n)&&n.length>0&&(d=n.filter((function(t){return!f.includes(t)}))).length>0&&(g=a(a({},g),function(t,e){void 0===e&&(e=[]);var o={};return e.forEach((function(e){var r=B(window.location.href,e);r&&(o[e]=r,o["".concat(t).concat(e)]=r)})),o}("H_latest_",d))),this.store.state.props=a(a(a(a(a({},this.store.state.props),e),p),g),h),this.store.setProps(this.store.state.props),this.store.getUtmFromProps(d)},r.prototype.getGeneralProperties=function(){var t=new $;return this.generalProperties=a(a(a({},this.generalProperties),{H_screen_width:window.screen.width,H_screen_height:window.screen.height,H_viewport_width:Y(),H_viewport_height:Z(),H_page_height:document.documentElement.scrollHeight||document.body.scrollHeight,H_browser:t.browserName,H_browser_version:t.browserVersion,H_os:t.os,H_os_version:t.osVersion,H_model:t.model,H_is_first_day:this.store.isFirstDay,H_url:window.location.href,H_url_host:D(window.location.href,"url_host取值异常"),H_title:document.title}),this.store.hLatestUtm),this.generalProperties.H_latest_referrer&&(this.generalProperties.H_latest_referrer_host=D(this.generalProperties.H_latest_referrer,"hostname解析异常")),this.generalProperties},r.prototype.initPlugins=function(){var t=this,e=this.options,o=e.serverUrl,r=e.name,n=e.showLog,i=e.sendType,s=e.customHeaders,c=e.credentials,u=e.dataSendTimeout,l=e.batchSend,p=e.imgUseCrossOrigin,h=e.globalCallback,f=e.plugins,d=void 0===f?[]:f,g=e.performanceErrorConfig,v=e.autoTrackConfig,m=e.siteLinkerConfig,y=e.abTestingPluginConfig;d=d||[];var w=v.pageLeaveAutoTrack,T=new gt(this.options,this),S=new vt(this.options,this),x=new bt(this.options,this),k=new wt(this.options,this),C=new mt(this.options,this),H=new yt(this.options,this),R=new Tt(this.options,this);C.disabled=!(b(w)&&!A(w));var I=(m||{}).linker;H.disabled=!(_(I)&&I.length>0),R.disabled=!(b(y)&&!A(y)),this.plugins=[T,S,x,k,C,H,R],_(d)&&d.forEach((function(e){if("Monitor"===e.componentName){if(b(g)&&!A(g))new e(a({serverUrl:o,name:r,showLog:n,sendType:i,customHeaders:s,credentials:c,dataSendTimeout:u,batchSend:l,imgUseCrossOrigin:p,globalCallback:h},g),!0)}else{var f=new e(t.options,t);t.plugins.push(f)}})),this.runPlugins(this.plugins)},r.prototype.use=function(e,o){if(this.isReady){if(b(o)){"PageLeave"===e?this.options.autoTrackConfig.pageLeaveAutoTrack=o:"SiteLinker"===e?this.options.siteLinkerConfig=o:"HinaABTest"===e&&(this.options.abTestingPluginConfig=o);var r=this.plugins.find((function(t){return t.name===e}));return r&&(r.disabled=!1,r.isReady?this.log("".concat(e,"插件已运行，无需重复执行"),t.ConsoleTypes.WARN):r.init()),this.getPluginInstance(e)}this.log("".concat(e,"插件配置项必须是一个对象类型"),t.ConsoleTypes.WARN)}else this.log("请先初始化埋点SDK",t.ConsoleTypes.WARN)},r.prototype.getPluginInstance=function(t){return this.plugins.find((function(e){return e.name===t}))},r.prototype.setConfig=function(t){this.options=I(this.options,t),this.normalizeConfig()},r.prototype.getConfig=function(t){return t?this.options[t]:this.options},r.prototype.setUserUId=function(e,o){var r=this;!function(e,o,r){x(e=null!=e?e:"")||S(e)?o!==(e=String(e).trim())?r(e):V("setUserUId: uid is equal to account_id, failed to execute setUserUId",t.ConsoleTypes.WARN):V("setUserUId: uid must be string or number",t.ConsoleTypes.WARN)}(e,this.store.getAccountId(),(function(t){r.store.setAccountId(t);var e=r.getReportData("track_signup","H_SignUp",{});r.report(e,o)}))},r.prototype.cleanUserUId=function(){this.store.setAccountId("")},r.prototype.getUserUid=function(){return this.store.state.accountId},r.prototype.setDeviceUId=function(t){this.store.setDeviceId(t)},r.prototype.getDeviceUId=function(){return this.store.getDeviceId()},r.prototype.userSet=function(t,e){if(b(t)&&!A(t)){var o=this.getReportData("user_set","",t);this.report(o,e)}},r.prototype.userSetOnce=function(t,e){if(b(t)&&!A(t)){var o=this.getReportData("user_setOnce","",t);this.report(o,e)}},r.prototype.userAdd=function(e,o){var r=this;!function(e,o){var r;S(e)&&((r={})[e]=1,e=r),b(e)&&!A(e)&&function(e){for(var o in e)if(!/-*\d+/.test(String(e[o])))return V("userAdd属性的值只能是数字",t.ConsoleTypes.WARN),!1;return!0}(e)&&o(e)}(e,(function(t){var e=r.getReportData("user_add","",t);r.report(e,o)}))},r.prototype.userAppend=function(t,e){var o=this;!function(t,e){var o={};b(t)&&(Object.keys(t).forEach((function(e){var r=t[e];_(r)?o[e]=r:o[e]=[r]})),A(o)||e(o))}(t,(function(t){var r=o.getReportData("user_append","",t);o.report(r,e)}))},r.prototype.userUnset=function(e,o){var r=this;!function(e,o){var r={};S(e)&&(e=[e]),_(e)?(e.forEach((function(e){S(e)?r[e]=!0:V("userUnset参数数组里面的值必须是string,已经过滤掉".concat(e),t.ConsoleTypes.WARN)})),A(r)||o(r)):V("userUnset参数必须是数组或字符串",t.ConsoleTypes.WARN)}(e,(function(t){var e=r.getReportData("user_unset","",t);r.report(e,o)}))},r.prototype.userDelete=function(t){var e=this.getReportData("user_delete","",{});this.report(e,t),this.store.setAccountId("")},r.prototype.registerCommonProperties=function(t){this.customProperties=I(this.customProperties,t)},r.prototype.getPresetProperties=function(){return a(a({},this.getGeneralProperties()),this.customProperties)},r.prototype.clearPageRegister=function(t){var e=this;void 0===t&&(t=!0),!0===t?this.customProperties={}:_(t)&&t.forEach((function(t){t in e.customProperties&&delete e.customProperties[t]}))},r.prototype.track=function(e,o,r){if(r=r||function(){},S(e)){o=b(o)?o:{};var n=this.getReportData("track",e,o);this.report(n,r)}else this.log("track事件名必须是字符串，属性必须是是一个对象",t.ConsoleTypes.WARN)},r.prototype.quick=function(t,e,o){if(!this.isReady)return this.log("请先初始化SDK");var r={};o=T(o)?o:C,b(e)?r=e:T(e)&&(o=e),this.autoTrack(r,o)},r.prototype.autoTrack=function(t,e){void 0===t&&(t={}),void 0===e&&(e=C);var o=(null==t?void 0:t.H_referrer)||O(),r=a(a(a({H_is_first_time:this.store.isFirstTime,H_url_path:window.location.pathname,H_referrer:o,H_referrer_host:o?D(o):""},this.store.hUtm),this.store.customUtm),t||{}),n=this.getReportData("track","H_pageview",r);if(this.report(n,e),this.store.isFirstTime){this.store.isFirstTime=!1;var i=O(),s=a(a({H_first_visit_time:R(),H_first_referrer:i,H_first_referrer_host:i?D(i,"取值异常"):"",H_first_traffic_source_type:St.getSourceFromReferrer(),H_first_search_keyword:St.getKeywordFromReferrer(),H_first_browser_language:S(navigator.language)?navigator.language.toLowerCase():"取值异常",H_first_browser_charset:document.characterSet||document.inputEncoding||"UTF-8"},this.store.hUtm),this.store.customUtm);this.userSetOnce(s)}},r.prototype.report=function(e,o,r){var n,i,a=this.options,s=a.appJsBridge,c=a.serverUrl;if(this.log(e),s){var u=!0,l=null===window||void 0===window?void 0:window.Hina_Cloud_H5_Bridge;if(b(l)&&l.track)u=!1,l.track(e.event,e.type,JSON.stringify(e));else{var p=null===(i=null===(n=null===window||void 0===window?void 0:window.webkit)||void 0===n?void 0:n.messageHandlers)||void 0===i?void 0:i.hinaNativeTracker;if(null==p?void 0:p.postMessage){u=!1;var h=JSON.stringify({eventName:e.event,eventType:e.type,properties:e});p.postMessage(h)}}if(u)return void this.log("JSBridge 发送数据失败",t.ConsoleTypes.WARN);T(o)&&o(c,e)}else this.sendReportData(e,o,r)},r.prototype.getReportData=function(t,e,o){var r,n=this.store.getAnonymousId(),i=this.store.getAccountId(),s=R(),c=I(this.customProperties),u=this.getGeneralProperties();if("user"===t.slice(0,4)){var l=u.H_lib,p=u.H_lib_method,h=u.H_lib_version;r=a({device_id:this.store.getDeviceId(),H_lib:l,H_lib_method:p,H_lib_version:h},o||{})}else r=a(a(a({device_id:this.store.getDeviceId()},u),c),o||{});nt(r,this.options.maxStringLength);var f={anonymous_id:n,type:t,event:e,time:s,_track_id:U(),properties:r};return i&&!/^[0-9a-f]{8,}-[0-9a-f]{4,}-[0-9a-f]{4,}-[0-9a-f]{4,}-[0-9a-f]{12,}$/.test(i)&&(f.account_id=i),f.send_time=R(),f},r}(ct);var Ct=new kt({},!1);t.HinaTrack=kt,t.PluginBase=h,t.default=Ct,Object.defineProperty(t,"__esModule",{value:!0})}));
